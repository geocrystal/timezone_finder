#!/bin/bash

# Post-install script to download combined-with-oceans-1970.json
# from timezone-boundary-builder releases

set -e

DATA_DIR="data"
DATA_FILE="combined-with-oceans-1970.json"
TARGET_FILE="${DATA_DIR}/${DATA_FILE}"

# Check if file already exists
if [ -f "${TARGET_FILE}" ]; then
  echo "✓ ${DATA_FILE} already exists, skipping download"
  exit 0
fi

echo "Downloading ${DATA_FILE} from timezone-boundary-builder releases..."

# Get the latest release tag (fallback to 2025b if API fails)
LATEST_TAG=$(curl -s https://api.github.com/repos/evansiroky/timezone-boundary-builder/releases/latest | grep -o '"tag_name": "[^"]*"' | cut -d'"' -f4 || echo "2025b")

# Construct the direct download URL
RELEASE_URL="https://github.com/evansiroky/timezone-boundary-builder/releases/download/${LATEST_TAG}/timezones-with-oceans-1970.geojson.zip"

echo "Downloading from release ${LATEST_TAG}..."

# Create data directory if it doesn't exist
mkdir -p "${DATA_DIR}"

# Download the zip file
TEMP_ZIP=$(mktemp)
echo "Downloading..."
curl -L -o "${TEMP_ZIP}" "${RELEASE_URL}"

# Extract the combined-with-oceans-1970.json from the zip
echo "Extracting..."
if command -v unzip >/dev/null 2>&1; then
  unzip -q -j "${TEMP_ZIP}" "combined-with-oceans-1970.json" -d "${DATA_DIR}" || {
    echo "✗ Error: Could not extract combined-with-oceans-1970.json from zip"
    echo "   The zip file may have a different structure"
    rm -f "${TEMP_ZIP}"
    exit 1
  }
else
  echo "✗ Error: unzip command not found. Please install unzip or extract manually."
  rm -f "${TEMP_ZIP}"
  exit 1
fi

# Clean up
rm -f "${TEMP_ZIP}"

# Verify the file was extracted
if [ -f "${TARGET_FILE}" ]; then
  FILE_SIZE=$(du -h "${TARGET_FILE}" | cut -f1)
  echo "✓ Successfully downloaded ${DATA_FILE} (${FILE_SIZE})"
else
  echo "✗ Error: File extraction failed"
  exit 1
fi
